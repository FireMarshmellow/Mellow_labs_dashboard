{% extends "base.html" %}
{% block content %}
<div class="grid gap-6">
  <!-- Social burner strip -->
  <div class="grid grid-cols-3 gap-4">
    <div class="p-4 rounded-2xl bg-slate-800">
      <div class="text-slate-400 text-xs uppercase">YouTube Subs</div>
      <div class="text-3xl font-bold">{{ s.youtube_subs or '—' }}</div>
    </div>
    <div class="p-4 rounded-2xl bg-slate-800">
      <div class="text-slate-400 text-xs uppercase">Instagram Followers</div>
      <div class="text-3xl font-bold">{{ s.instagram_followers or '—' }}</div>
    </div>
    <div class="p-4 rounded-2xl bg-slate-800">
      <div class="text-slate-400 text-xs uppercase">TikTok Followers</div>
      <div class="text-3xl font-bold">{{ s.tiktok_followers or '—' }}</div>
    </div>
  </div>

  <!-- Branding row -->
  <div class="flex items-center gap-4">
    {% if s.logo_path %}<img src="{{ s.logo_path }}" class="h-12 w-12 rounded-xl object-cover" />{% endif %}
    <h1 class="text-2xl font-semibold">{{ s.company_name }}</h1>
  </div>

  <!-- Mirrored bar chart for last 5 tax years (monthly) -->
  <div class="p-4 rounded-2xl bg-slate-800">
    <canvas id="mirrorChart"></canvas>
  </div>

  <!-- Current FY pies -->
  <div class="grid grid-cols-2 gap-4">
    <div class="p-4 rounded-2xl bg-slate-800">
      <h2 class="mb-2 font-medium">Income by Source (Current Tax Year)</h2>
      <canvas id="incomePie" style="height:280px"></canvas>
    </div>
    <div class="p-4 rounded-2xl bg-slate-800">
      <h2 class="mb-2 font-medium">Expenses by Category (Current Tax Year)</h2>
      <canvas id="expensePie" style="height:280px"></canvas>
    </div>
  </div>

  <!-- Lifetime pies -->
  <div class="grid grid-cols-2 gap-4">
    <div class="p-4 rounded-2xl bg-slate-800">
      <h2 class="mb-2 font-medium">Income by Source (All Time)</h2>
      <canvas id="incomePieAll" style="height:280px"></canvas>
    </div>
    <div class="p-4 rounded-2xl bg-slate-800">
      <h2 class="mb-2 font-medium">Expenses by Category (All Time)</h2>
      <canvas id="expensePieAll" style="height:280px"></canvas>
    </div>
  </div>
</div>

<script>
  // Data is injected from server
  const mirrorData = {{ mirror_data | tojson }}; // {labels: [...months], income:[...], expenses:[...]}
  const pies = {{ pies | tojson }}; // {incomeFY:{labels,data}, expenseFY:{...}, incomeAll:{...}, expenseAll:{...}}

  function showInlineError(msg){
    const box = document.createElement('div');
    box.className = 'text-rose-400 text-xs mt-2';
    box.textContent = msg;
    document.currentScript.parentElement.appendChild(box);
  }

  try{
    // Mirrored chart (negative expenses to mirror from center)
    new Chart(document.getElementById('mirrorChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: mirrorData.labels || [],
        datasets: [
          {label: 'Income', data: (mirrorData.income||[]).map(Number), borderWidth: 1},
          {label: 'Expenses', data: (mirrorData.expenses||[]).map(v => -Number(v||0)), borderWidth: 1},
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: { stacked: false, ticks: { color: '#cbd5e1' } },
          y: { ticks: { color: '#cbd5e1' } }
        },
        plugins: { legend: { labels: { color: '#cbd5e1' } } }
      }
    });
  } catch(e){ showInlineError('Mirror chart error: '+e.message); }

  function makePie(id, payload){
    const el = document.getElementById(id);
    if(!el){ return; }
    try{
      const ctx = el.getContext('2d');
      const labels = (payload && Array.isArray(payload.labels)) ? payload.labels : [];
      const dataArr = (payload && Array.isArray(payload.data)) ? payload.data.map(x=>Number(x||0)) : [];
      const sum = dataArr.reduce((a,b)=>a + (isNaN(b)?0:b), 0);
      if(labels.length === 0 || dataArr.length === 0 || sum === 0){
        el.insertAdjacentHTML('afterend','<div class="text-slate-400 text-sm">No data for this period.</div>');
        el.remove();
        return;
      }
      const colors = labels.map((_, i) => `hsl(${(i*57)%360} 70% 50%)`);
      new Chart(ctx, {
        type: 'pie',
        data: { labels, datasets: [{ data: dataArr, backgroundColor: colors }] },
        options: { plugins: { legend: { labels: { color: '#cbd5e1' } } } }
      });
    } catch(e){
      el.insertAdjacentHTML('afterend','<div class="text-rose-400 text-xs">Pie error: '+e.message+'</div>');
    }
  }

  makePie('incomePie', pies && pies.incomeFY);
  makePie('expensePie', pies && pies.expenseFY);
  makePie('incomePieAll', pies && pies.incomeAll);
  makePie('expensePieAll', pies && pies.expenseAll);
</script>
{% endblock %}
