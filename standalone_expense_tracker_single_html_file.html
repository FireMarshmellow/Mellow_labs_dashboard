<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expenses — Standalone</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root { color-scheme: dark; }
    /* Prevent table jumping when scrollbar appears */
    html { overflow-y: scroll; }
    /* Simple truncation helper for notes */
    .truncate-26ch { max-width: 26ch; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    /* Numeric input spinner remove (webkit) */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    /* Enhanced UI Styles */
    .transition-all { transition: all 0.2s ease-in-out; }
    
    /* Form inputs styling */
    input, select, textarea {
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    
    input:hover, select:hover, textarea:hover {
      border-color: rgba(148, 163, 184, 0.2);
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: #3b82f6;
      outline: none;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    /* Table row hover effect */
    tr:hover:not(:first-child) {
      background-color: rgba(148, 163, 184, 0.05);
    }

    /* Button hover animations */
    .button-hover {
      transition: all 0.2s ease;
      transform: translateY(0);
    }
    
    .button-hover:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Card hover effects */
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(148, 163, 184, 0.1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.3);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.4);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 text-slate-100 min-h-screen">
  <main class="max-w-6xl mx-auto p-6 space-y-8">
    <header class="flex flex-col sm:flex-row items-center justify-between gap-4 bg-slate-800/50 p-6 rounded-2xl shadow-lg card-hover mb-6">
      <div class="flex items-center gap-3">
        <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
        <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-500 to-blue-300 bg-clip-text text-transparent">Expenses</h1>
      </div>
      <div class="flex gap-3">
        <button id="btnExport" class="button-hover text-sm px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
          </svg>
          Export CSV
        </button>
        <label class="button-hover text-sm px-4 py-2 rounded-lg bg-green-600 hover:bg-green-500 cursor-pointer flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
          </svg>
          Import CSV<input id="fileImport" type="file" accept=".csv,text/csv" class="hidden" />
        </label>
        <button id="btnClear" class="button-hover text-sm px-4 py-2 rounded-lg bg-rose-600 hover:bg-rose-500 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
          Clear All
        </button>
      </div>
    </header>

    <!-- Form Card -->
    <section class="p-6 rounded-2xl bg-slate-800/90 max-w-3xl shadow-lg backdrop-blur-sm card-hover mx-auto">
      <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        New Expense
      </h2>
      <form id="expenseForm" class="grid gap-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div>
            <label for="date" class="text-xs text-slate-300">Date</label>
            <input id="date" type="date" name="date" required class="w-full bg-slate-900 rounded px-2.5 py-1.5 text-sm" />
          </div>
          <div>
            <label class="text-xs text-slate-300">Category</label>
            <div class="flex gap-2">
              <select id="category" name="category" class="flex-1 bg-slate-900 rounded px-2.5 py-1.5 text-sm"></select>
              <button id="btnAddCategory" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600" title="Add category" type="button">Add</button>
            </div>
          </div>
          <div>
            <label for="seller" class="text-xs text-slate-300">Seller</label>
            <input id="seller" name="seller" required class="w-full bg-slate-900 rounded px-2.5 py-1.5 text-sm" />
          </div>
          <div>
            <label for="items" class="text-xs text-slate-300">Item(s)</label>
            <input id="items" name="items" class="w-full bg-slate-900 rounded px-2.5 py-1.5 text-sm" placeholder="What you bought" />
          </div>
          <div>
            <label for="orderNumber" class="text-xs text-slate-300">Order #</label>
            <input id="orderNumber" name="orderNumber" class="w-full bg-slate-900 rounded px-2.5 py-1.5 text-sm" />
          </div>
          <div>
            <label for="total" class="text-xs text-slate-300">Total Amount (£)</label>
            <input id="total" type="number" step="0.01" min="0" name="total" required class="w-full bg-slate-900 rounded px-2.5 py-1.5 text-sm" />
          </div>
          <div>
            <label for="notes" class="text-xs text-slate-300">Notes</label>
            <textarea id="notes" name="notes" class="w-full bg-slate-900 rounded px-2.5 py-1.5 text-sm" rows="2"></textarea>
          </div>
          <div>
            <label for="source" class="text-xs text-slate-300">Source</label>
            <select id="source" name="source" class="w-full bg-slate-900 rounded px-2.5 py-1.5 text-sm">
              <option value="Amazon">Amazon</option>
              <option value="AliExpress">AliExpress</option>
              <option value="eBay">eBay</option>
              <option value="Custom">Custom</option>
            </select>
          </div>
          <div class="col-span-full sm:col-span-1">
            <button class="w-full py-1.5 rounded bg-blue-600 hover:bg-blue-500 text-sm" type="submit">Add Expense</button>
          </div>
        </div>
      </form>
    </section>

    <!-- Table Card -->
    <section class="p-6 rounded-2xl bg-slate-800/90 shadow-lg backdrop-blur-sm card-hover max-w-[1160px] mx-auto">
      <div class="flex flex-col sm:flex-row gap-4 sm:items-center justify-between mb-6">
        <div class="flex items-center gap-4">
          <div class="bg-slate-700/50 rounded-lg p-3 text-center">
            <div class="text-xs text-slate-400 mb-1">Entries</div>
            <div class="text-xl font-semibold text-blue-400" id="count">0</div>
          </div>
          <div class="bg-slate-700/50 rounded-lg p-3 text-center">
            <div class="text-xs text-slate-400 mb-1">Total</div>
            <div class="text-xl font-semibold text-green-400" id="sum">£0.00</div>
          </div>
        </div>
        <div class="flex gap-4 text-sm">
          <label class="flex items-center gap-2 bg-slate-700/30 rounded-lg px-4 py-2">
            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input id="filter" placeholder="Filter expenses..." class="bg-transparent border-none focus:ring-0 px-2 py-1 w-48" />
          </label>
          <label class="flex items-center gap-2 bg-slate-700/30 rounded-lg px-4 py-2">
            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"></path>
            </svg>
            <select id="sortBy" class="bg-transparent border-none focus:ring-0 px-2 py-1">
              <option value="date desc">Latest First</option>
              <option value="date asc">Oldest First</option>
              <option value="amount desc">Highest Amount</option>
              <option value="amount asc">Lowest Amount</option>
            </select>
          </label>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-slate-400 border-b border-slate-700/50">
              <th class="py-4 px-3 font-medium whitespace-nowrap w-[100px]">Date</th>
              <th class="py-4 px-3 font-medium whitespace-nowrap w-[120px]">Category</th>
              <th class="py-4 px-3 font-medium whitespace-nowrap w-[140px]">Seller</th>
              <th class="py-4 px-3 font-medium whitespace-nowrap w-[140px]">Item(s)</th>
              <th class="py-4 px-3 font-medium whitespace-nowrap w-[100px]">Order #</th>
              <th class="py-4 px-3 font-medium text-right whitespace-nowrap w-[100px]">Total</th>
              <th class="py-4 px-3 font-medium whitespace-nowrap w-[120px]">Notes</th>
              <th class="py-4 px-3 font-medium whitespace-nowrap w-[100px]">Source</th>
              <th class="py-4 px-3 font-medium text-right whitespace-nowrap w-[140px]">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <template id="rowTpl">
    <tr class="border-t border-slate-700/50 transition-colors">
      <td class="py-4 px-3 whitespace-nowrap" data-k="date"></td>
      <td class="px-3"><span class="px-2 py-1 rounded-full text-xs bg-slate-700/50 inline-block max-w-[110px] truncate" data-k="category"></span></td>
      <td class="px-3 max-w-[140px] truncate" data-k="seller"></td>
      <td class="px-3 max-w-[140px] truncate" data-k="items"></td>
      <td class="px-3 whitespace-nowrap"><span class="text-xs text-slate-400" data-k="orderNumber"></span></td>
      <td class="text-right px-3 font-medium whitespace-nowrap" data-k="totalFmt"></td>
      <td class="px-3 max-w-[120px] truncate" title="" data-k="notes"></td>
      <td class="px-3 whitespace-nowrap"><span class="text-xs px-2 py-1 rounded-full bg-blue-900/30 text-blue-300 inline-block max-w-[90px] truncate" data-k="source"></span></td>
      <td class="text-right px-3 whitespace-nowrap">
        <button class="button-hover text-xs px-3 py-1 rounded-lg bg-slate-700 hover:bg-slate-600 flex items-center gap-1 inline-flex" data-act="edit">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
          Edit
        </button>
        <button class="button-hover text-xs px-3 py-1 rounded-lg bg-rose-700 hover:bg-rose-600 ml-2 flex items-center gap-1 inline-flex" data-act="del">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
          Delete
        </button>
      </td>
    </tr>
  </template>

  <script>
    // === Simple local persistence ===
    const LS_KEY_DATA = 'expenses.v1';
    const LS_KEY_CATS = 'expenseCategories.v1';

    const gbp = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' });

    /** @type {Array<{id:string,date:string,category:string,seller:string,orderNumber:string,total:number,notes:string}>} */
    let DATA = loadJSON(LS_KEY_DATA, []);
    /** @type {string[]} */
    let CATS = loadJSON(LS_KEY_CATS, ['—', 'Supplies', 'Software', 'Travel', 'Materials', 'Services']);

    // === Elements ===
    const form = document.getElementById('expenseForm');
    const tbody = document.getElementById('tbody');
    const count = document.getElementById('count');
    const sum = document.getElementById('sum');
    const sortBy = document.getElementById('sortBy');
    const filter = document.getElementById('filter');
    const catSelect = document.getElementById('category');

    // Prefill today's date
    document.getElementById('date').valueAsDate = new Date();

    // Populate categories
    function renderCats() {
      catSelect.innerHTML = '';
      CATS.forEach((c, i) => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        catSelect.appendChild(opt);
      });
    }

    function saveAll() {
      localStorage.setItem(LS_KEY_DATA, JSON.stringify(DATA));
      localStorage.setItem(LS_KEY_CATS, JSON.stringify(CATS));
    }

    function loadJSON(key, def) {
      try { const v = JSON.parse(localStorage.getItem(key)); return Array.isArray(def) && !Array.isArray(v) ? def : (v ?? def); } catch { return def; }
    }

    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }

    function sanitizeCSV(s) {
      if (s == null) return '';
      const str = String(s);
      return /[",\n]/.test(str) ? '"' + str.replaceAll('"', '""') + '"' : str;
    }

    function toCSV(rows) {
      const header = ['Date','Category','Seller','Item(s)','Order #','TotalGBP','Notes','Source'];
      const lines = [header.join(',')];
      for (const r of rows) {
        lines.push([
          sanitizeCSV(r.date),
          sanitizeCSV(r.category),
          sanitizeCSV(r.seller),
          sanitizeCSV(r.items || ''), // Include the "Item(s)" field
          sanitizeCSV(r.orderNumber || ''),
          (Number(r.total) || 0).toFixed(2),
          sanitizeCSV(r.notes || ''),
          sanitizeCSV(r.source || '') // Include the "Source" field
        ].join(','));
      }
      return lines.join('\n');
    }

    function parseCSV(text) {
      // Minimal CSV parser: supports quoted fields and commas
      const rows = [];
      let i = 0, field = '', row = [], inQuotes = false;
      while (i < text.length) {
        const ch = text[i++];
        if (inQuotes) {
          if (ch === '"') {
            if (text[i] === '"') { field += '"'; i++; }
            else { inQuotes = false; }
          } else field += ch;
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ',') { row.push(field); field = ''; }
          else if (ch === '\n' || ch === '\r') {
            if (field !== '' || row.length) { row.push(field); rows.push(row); row = []; field = ''; }
          } else field += ch;
        }
      }
      if (field !== '' || row.length) { row.push(field); rows.push(row); }
      return rows.filter(r => r.length > 1);
    }

    function csvToExpenses(csvText) {
      const rows = parseCSV(csvText);
      if (!rows.length) return [];
      const header = rows[0].map(h => h.trim().toLowerCase());
      const idx = {
        date: header.indexOf('date'),
        category: header.indexOf('category'),
        seller: header.indexOf('seller'),
        items: header.indexOf('item(s)'), // Added "Item(s)" field
        order: header.findIndex(h => h.startsWith('order')),
        total: header.findIndex(h => h.startsWith('total')),
        notes: header.indexOf('notes'),
        source: header.indexOf('source') // Added "Source" field
      };
      const out = [];
      for (let r = 1; r < rows.length; r++) {
        const row = rows[r];
        if (!row[idx.date]) continue;
        out.push({
          id: uid(),
          date: row[idx.date] || '',
          category: row[idx.category] || '—',
          seller: row[idx.seller] || '',
          items: row[idx.items] || '', // Include "Item(s)" data
          orderNumber: row[idx.order] || '',
          total: Number(String(row[idx.total] || '0').replace(/[^0-9.\-]/g, '')) || 0,
          notes: row[idx.notes] || '',
          source: row[idx.source] || '' // Include "Source" data
        });
      }
      return out;
    }

    function render() {
      // Filter & sort
      const q = filter.value.trim().toLowerCase();
      const [key, dir] = sortBy.value.split(' ');
      const rows = DATA.filter(r =>
        !q || [r.date, r.category, r.seller, r.items, r.orderNumber, r.notes, r.total] // Include "Item(s)" in filter
          .join(' ').toLowerCase().includes(q)
      ).sort((a,b)=>{
        if (key === 'date') return (a.date < b.date ? -1: a.date > b.date ? 1 : 0) * (dir==='asc'?1:-1);
        if (key === 'amount') return ((a.total||0) - (b.total||0)) * (dir==='asc'?1:-1);
        return 0;
      });

      // Tally
      count.textContent = String(rows.length);
      const totalSum = rows.reduce((acc, r) => acc + (Number(r.total)||0), 0);
      sum.textContent = gbp.format(totalSum);

      // Table
      tbody.innerHTML = '';
      const tpl = document.getElementById('rowTpl');
      for (const r of rows) {
        const tr = tpl.content.firstElementChild.cloneNode(true);
        tr.querySelector('[data-k=date]').textContent = r.date || '';
        tr.querySelector('[data-k=category]').textContent = r.category || '';
        tr.querySelector('[data-k=seller]').textContent = r.seller || '';
        tr.querySelector('[data-k=items]').textContent = r.items || ''; // Populate Item(s) column
        tr.querySelector('[data-k=orderNumber]').textContent = r.orderNumber || '';
        tr.querySelector('[data-k=totalFmt]').textContent = gbp.format(Number(r.total)||0);
        const notesEl = tr.querySelector('[data-k=notes]');
        notesEl.textContent = r.notes || '';
        notesEl.title = r.notes || '';
        tr.querySelector('[data-k=source]').textContent = r.source || ''; // Populate Source column
        tr.dataset.id = r.id;
        tbody.appendChild(tr);
      }
    }

    function addExpenseFromForm(evt) {
      evt.preventDefault();
      const date = form.date.value;
      const category = form.category.value || '—';
      const seller = form.seller.value.trim();
      const orderNumber = form.orderNumber.value.trim();
      const total = Number(form.total.value);
      const notes = form.notes.value.trim();
      const source = form.source.value;
      if (!date || !seller || isNaN(total)) return;
      DATA.push({ id: uid(), date, category, seller, orderNumber, total, notes, source });
      saveAll();
      render();
      exportCSV(); // Automatically save to CSV after adding an expense
      form.reset();
      form.date.valueAsDate = new Date();
      form.category.value = category; // keep last cat
      form.seller.focus();
    }

    function onTableClick(evt) {
      const btn = evt.target.closest('button');
      if (!btn) return;
      const tr = btn.closest('tr');
      const id = tr?.dataset?.id;
      const idx = DATA.findIndex(r => r.id === id);
      if (idx === -1) return;
      const rec = DATA[idx];
      if (btn.dataset.act === 'del') {
        if (confirm('Delete this expense?')) {
          DATA.splice(idx,1);
          saveAll();
          render();
        }
      } else if (btn.dataset.act === 'edit') {
        // very simple inline edit via prompts (keeps code light)
        const date = prompt('Date (YYYY-MM-DD):', rec.date) || rec.date;
        const category = prompt('Category:', rec.category) || rec.category;
        const seller = prompt('Seller:', rec.seller) || rec.seller;
        const orderNumber = prompt('Order #:', rec.orderNumber || '') ?? rec.orderNumber;
        const total = Number(prompt('Total (£):', rec.total)) || rec.total;
        const notes = prompt('Notes:', rec.notes || '') ?? rec.notes;
        const source = prompt('Source:', rec.source || '') ?? rec.source;
        Object.assign(rec, { date, category, seller, items, orderNumber, total, notes, source });
        if (!CATS.includes(category)) { CATS.push(category); renderCats(); }
        saveAll();
        render();
      }
    }

    function exportCSV() {
      const csv = toCSV(DATA);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      const d = new Date();
      const fname = `expenses-${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}.csv`;
      a.href = URL.createObjectURL(blob);
      a.download = fname;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    function importCSV(file) {
      const reader = new FileReader();
      reader.onload = () => {
        const items = csvToExpenses(String(reader.result || ''));
        if (!items.length) { alert('No rows found in CSV'); return; }
        // merge, avoid duplicates by (date, seller, total, orderNumber)
        const keyOf = r => [r.date,r.seller,Number(r.total).toFixed(2),r.orderNumber||''].join('|');
        const existing = new Set(DATA.map(keyOf));
        let added = 0;
        for (const it of items) {
          if (!existing.has(keyOf(it))) { DATA.push(it); added++; }
          if (it.category && !CATS.includes(it.category)) CATS.push(it.category);
        }
        saveAll(); renderCats(); render();
        alert(`Imported ${added} new row(s).`);
      };
      reader.readAsText(file);
    }

    function addCategoryFlow() {
      const name = prompt('Add new expense category');
      if (!name) return;
      if (!CATS.includes(name)) {
        CATS.push(name);
        saveAll();
        renderCats();
      }
      catSelect.value = name;
    }

    // Add event listener for the Source dropdown
    const sourceSelect = document.getElementById('source');
    sourceSelect.addEventListener('change', () => {
      if (sourceSelect.value === 'Custom') {
        const customSource = prompt('Enter custom source:');
        if (customSource) {
          // Add the custom source to the dropdown options
          const customOption = document.createElement('option');
          customOption.value = customSource;
          customOption.textContent = customSource;
          sourceSelect.appendChild(customOption);
          sourceSelect.value = customSource; // Set the selected value to the custom source
        } else {
          // Reset to default if no input is provided
          sourceSelect.value = '';
        }
      }
    });

    // === Event wiring ===
    form.addEventListener('submit', addExpenseFromForm);
    document.getElementById('btnAddCategory').addEventListener('click', addCategoryFlow);
    document.getElementById('btnExport').addEventListener('click', exportCSV);
    document.getElementById('btnClear').addEventListener('click', () => {
      if (!confirm('This will clear ALL stored expenses and categories (keeps defaults). Continue?')) return;
      DATA = [];
      CATS = ['—', 'Supplies', 'Software', 'Travel', 'Meals', 'Services'];
      saveAll(); renderCats(); render();
    });
    document.getElementById('fileImport').addEventListener('change', (e) => {
      const f = e.target.files?.[0]; if (f) importCSV(f); e.target.value = '';
    });
    sortBy.addEventListener('change', render);
    filter.addEventListener('input', render);
    tbody.addEventListener('click', onTableClick);

    // Initial paint
    renderCats();
    render();
  </script>
</body>
</html>
